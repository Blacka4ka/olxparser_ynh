#!/bin/bash

# YunoHost helpers
source _common.sh || exit 1

# Стандартні змінні
app=$YNH_APP_INSTANCE_NAME
domain=$(ynh_app_setting_get $app domain)
path_url=$(ynh_app_setting_get $app path)

# Кроки інсталяції
ynh_script_progression --message="Створення каталогу додатка..." --time
app_dir="/var/www/$app"
mkdir -p "$app_dir"

# Копіюємо Flask-додаток
cp -r ../src/app/* "$app_dir"

# Віртуальне оточення
python3 -m venv "$app_dir/venv"
source "$app_dir/venv/bin/activate"
pip install -r "$app_dir/requirements.txt"

# Система systemd
ynh_add_systemd_service --service_name "$app" --exec_start "$app_dir/venv/bin/python $app_dir/main.py"

# Nginx
ynh_add_nginx_config --domain="$domain" --path_url="$path_url" --app="$app"

ynh_systemd_action --service_name="$app" --action=restart

ynh_script_progression --message="Інсталяція завершена!" --time
