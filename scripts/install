#!/bin/bash
set -e

APP_ID="olxparser"
APP_DIR="/opt/yunohost/apps/$APP_ID"
VENV_DIR="$APP_DIR/venv"

echo "Створення директорії додатку..."
mkdir -p "$APP_DIR"

echo "Копіювання файлів додатку..."
cp -r $PWD/* "$APP_DIR"

echo "Створення віртуального оточення Python..."
python3 -m venv "$VENV_DIR"

echo "Активація віртуального оточення та встановлення залежностей..."
source "$VENV_DIR/bin/activate"
pip install --upgrade pip
pip install -r "$APP_DIR/src/requirements.txt"
deactivate

echo "Створення systemd сервісу для Flask додатку..."

SERVICE_FILE="/etc/systemd/system/$APP_ID.service"

cat <<EOF > "$SERVICE_FILE"
[Unit]
Description=OLX Parser Flask App
After=network.target

[Service]
User=yunohost
Group=yunohost
WorkingDirectory=$APP_DIR/src
ExecStart=$VENV_DIR/bin/gunicorn -w 3 -b 0.0.0.0:5000 app:app

[Install]
WantedBy=multi-user.target
EOF

echo "Перезавантаження systemd і запуск сервісу..."
systemctl daemon-reload
systemctl enable $APP_ID
systemctl start $APP_ID

echo "Інсталяція завершена."
