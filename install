#!/bin/bash

# Встановлення залежностей пакета
set -e

APP_DIR="/opt/yunohost.olxparser"
SRC_DIR="$APP_DIR/src"
VENV_DIR="$APP_DIR/venv"

echo "Створюємо директорію додатку..."
mkdir -p $SRC_DIR

echo "Копіюємо файли додатку..."
cp -r src/* $SRC_DIR/

echo "Створюємо віртуальне оточення..."
python3 -m venv $VENV_DIR

echo "Активуємо віртуальне оточення і встановлюємо залежності..."
$VENV_DIR/bin/pip install --upgrade pip
$VENV_DIR/bin/pip install -r $SRC_DIR/requirements.txt

echo "Створюємо systemd сервіс для запуску додатку..."

cat > /etc/systemd/system/yunohost.olxparser.service <<EOF
[Unit]
Description=OLX Parser Flask App
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=$SRC_DIR
Environment="PATH=$VENV_DIR/bin"
ExecStart=$VENV_DIR/bin/python $SRC_DIR/app.py

[Install]
WantedBy=multi-user.target
EOF

echo "Перезавантажуємо systemd і запускаємо сервіс..."
systemctl daemon-reload
systemctl enable yunohost.olxparser.service
systemctl restart yunohost.olxparser.service

echo "Готово! OLX парсер встановлено і запущено."
